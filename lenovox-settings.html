<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings • Lenovox AI</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 420px;
  margin: auto;
  background: white;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
h2 {
  text-align: center;
  margin-bottom: 20px;
}
.profile {
  text-align: center;
}
.profile img {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  object-fit: cover;
  cursor: pointer;
  border: 3px solid #32a852;
  transition: 0.3s;
}
.profile img:hover {
  transform: scale(1.05);
}
input, select, button {
  width: 100%;
  margin-top: 12px;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 15px;
}
button {
  background: #32a852;
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
button:hover {
  opacity: 0.9;
}
.logout {
  background: #000;
  margin-top: 20px;
}
small {
  display: block;
  text-align: center;
  color: #666;
  margin-top: 10px;
}
.dark {
  background: #111;
  color: white;
}
.dark .container {
  background: #1c1c1c;
}
</style>
</head>
<body>

<div class="container">
  <h2>Settings</h2>

  <div class="profile">
    <img id="avatar" src="https://i.postimg.cc/MTd0xxGM/grok-1767825639177-1.jpg">
    <input type="file" id="photo" accept="image/*" hidden>
    <small>Tap image to change</small>
  </div>

  <input type="text" id="username" placeholder="Username" disabled>
  <input type="text" id="name" placeholder="Full Name">
  <input type="number" id="age" placeholder="Age">
  
  <select id="theme">
    <option value="">Select Theme</option>
    <option value="light">Light</option>
    <option value="dark">Dark</option>
  </select>

  <button id="saveBtn">Save Settings</button>
  <button id="changePasswordBtn">Change Password</button>
  <button class="logout" id="logoutBtn">Log Out</button>
</div>

<script type="module">
  import { watchAuth, logoutUser, resetPassword, updateDisplayName, getCurrentUser } from './auth.js';
  
  const avatar = document.getElementById("avatar");
  const photoInput = document.getElementById("photo");
  const nameInput = document.getElementById("name");
  const ageInput = document.getElementById("age");
  const themeSelect = document.getElementById("theme");
  const usernameInput = document.getElementById("username");
  const saveBtn = document.getElementById("saveBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const changePasswordBtn = document.getElementById("changePasswordBtn");

  avatar.onclick = () => photoInput.click();

  // Apply theme helper
  function applyTheme(theme) {
    if (theme === "dark") {
      document.body.classList.add("dark");
    } else {
      document.body.classList.remove("dark");
    }
  }

  // Load user info from session/localStorage
  const session = getCurrentUser();
  if (session) {
    usernameInput.value = "user_" + session.uid.slice(0,6);
    nameInput.value = session.name || "";
    ageInput.value = session.age || "";
    themeSelect.value = session.theme || "";
    applyTheme(session.theme);
    if (session.photoURL) avatar.src = session.photoURL;
  }

  // Preview selected photo
  photoInput.addEventListener("change", e => {
    const file = e.target.files[0];
    if (file) avatar.src = URL.createObjectURL(file);
  });

  // Save settings
  saveBtn.addEventListener("click", async () => {
    const user = getCurrentUser();
    if (!user) {
      alert("You must be logged in to save settings!");
      return;
    }

    // Update display name
    if (nameInput.value) {
      await updateDisplayName(nameInput.value);
    }

    // Save theme/age to session/localStorage
    const newSession = { ...user, age: ageInput.value, theme: themeSelect.value };
    localStorage.setItem("userSession", JSON.stringify(newSession));

    applyTheme(themeSelect.value);
    alert("Settings saved ✅");
  });

  // Change password
  changePasswordBtn.addEventListener("click", async () => {
    const email = session?.email;
    if (!email) {
      alert("No logged-in user!");
      return;
    }
    const confirmReset = confirm("Do you want to send a password reset email?");
    if (confirmReset) {
      try {
        await resetPassword(email);
        alert("Password reset email sent ✅");
      } catch (err) {
        alert(err.message);
      }
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await logoutUser();
    alert("Logged out successfully!");
    window.location.href = "login.html";
  });
</script>

</body>
</html>
