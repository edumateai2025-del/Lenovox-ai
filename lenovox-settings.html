<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  margin:0;
  padding:20px;
}

/* Card */
.card{
  background:#fff;
  padding:20px;
  border-radius:16px;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);
  margin-bottom:20px;
}

/* Inputs */
input{
  width:100%;
  padding:12px;
  margin-top:8px;
  margin-bottom:16px;
  border-radius:10px;
  border:1px solid #ddd;
}

/* Button */
button{
  padding:12px 18px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:white;
  cursor:pointer;
  font-weight:bold;
}

/* Toast Containers */
#toastTop, #toastBottom{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  z-index:9999;
}
#toastTop{ top:20px; }
#toastBottom{ bottom:20px; }

/* Toast */
.toast{
  min-width:240px;
  padding:16px 22px;
  border-radius:14px;
  color:white;
  margin-top:10px;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
  animation:pop 0.3s ease;
}
.toast.success{ background:#22c55e; }
.toast.error{ background:#ef4444; }

@keyframes pop{
  from{ transform:scale(.8); opacity:0; }
  to{ transform:scale(1); opacity:1; }
}

img.profile{
  width:80px;
  height:80px;
  border-radius:50%;
  object-fit:cover;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div id="toastTop"></div>
<div id="toastBottom"></div>

<div class="card">
<h3>Profile Settings</h3>

<img id="profilePreview" class="profile" src="" />

<input id="displayName" placeholder="Your Name">
<input id="age" type="number" placeholder="Your Age">
<input id="photoFile" type="file">

<button id="savePersonal">Save Settings</button>
</div>

<div class="card">
<h3>Customer Support</h3>
<input id="supportMessage" placeholder="Tell us your issue...">
<button id="sendSupport">Send Feedback</button>
</div>

<script type="module">
import { watchAuth } from './auth.js';
import { getSession, saveSession } from './session.js';
import {
  getFirestore, doc, getDoc, setDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const db = getFirestore();
let currentUser=null;
let userDataFromDB=null;

/* ---------------- TOAST SYSTEM ---------------- */

function createToast(type,message){
  const t=document.createElement("div");
  t.className="toast "+type;
  t.textContent=message;
  return t;
}

function showSuccessToast(msg="Saved"){
  const t=createToast("success",msg);
  document.getElementById("toastBottom").appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

function showErrorToast(msg="Error"){
  const t=createToast("error",msg);
  document.getElementById("toastTop").appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

/* ---------------- LOAD USER ---------------- */

watchAuth(async(user)=>{
  if(!user) return;

  currentUser=user;

  const ref=doc(db,"users",user.uid);
  const snap=await getDoc(ref);

  if(snap.exists()){
    userDataFromDB=snap.data();
  }else{
    userDataFromDB={
      name:user.displayName||"",
      age:"",
      photo:"",
      nameChangedCount:0,
      ageChangedCount:0
    };
    await setDoc(ref,userDataFromDB);
  }

  populateUI();
});

/* ---------------- POPULATE UI ---------------- */

function populateUI(){
  document.getElementById("displayName").value=userDataFromDB.name||"";
  document.getElementById("age").value=userDataFromDB.age||"";

  if(userDataFromDB.photo){
    document.getElementById("profilePreview").src=userDataFromDB.photo;
  }
}

/* ---------------- SAVE PERSONAL ---------------- */

document.getElementById("savePersonal").onclick=async()=>{
try{
  const newName=document.getElementById("displayName").value.trim();
  const newAge=document.getElementById("age").value.trim();
  const file=document.getElementById("photoFile").files[0];

  if(newName!==userDataFromDB.name){
    if(userDataFromDB.nameChangedCount>=1)
      return showErrorToast("Name can only be changed once");

    userDataFromDB.nameChangedCount++;
    userDataFromDB.name=newName;
  }

  if(newAge!==userDataFromDB.age){
    if(userDataFromDB.ageChangedCount>=1)
      return showErrorToast("Age can only be changed once");

    userDataFromDB.ageChangedCount++;
    userDataFromDB.age=newAge;
  }

  if(file){
    const base64=await toBase64(file);
    userDataFromDB.photo=base64;
  }

  await updateDoc(doc(db,"users",currentUser.uid),userDataFromDB);

  saveSession(userDataFromDB);
  showSuccessToast("Settings saved");

}catch(err){
  console.error(err);
  showErrorToast("Failed to save");
}
};

/* ---------------- SUPPORT ---------------- */

document.getElementById("sendSupport").onclick=async()=>{
  const msg=document.getElementById("supportMessage").value.trim();
  if(!msg) return showErrorToast("Write a message first");

  await setDoc(doc(db,"support",Date.now().toString()),{
    uid:currentUser.uid,
    message:msg,
    created:new Date()
  });

  document.getElementById("supportMessage").value="";
  showSuccessToast("Feedback sent");
};

/* ---------------- HELPERS ---------------- */

function toBase64(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.readAsDataURL(file);
    r.onload=()=>res(r.result);
    r.onerror=err=>rej(err);
  });
}
</script>

</body>
</html>
