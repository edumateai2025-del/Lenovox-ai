<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Settings • Lenovox AI</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  transition: background 0.3s, color 0.3s;
}
/* Dark Mode Support */
body.dark { background: #1a1a1a; color: #eee; }
body.dark .container { background: #2d2d2d; color: #eee; border: 1px solid #444; }
body.dark input, body.dark select, body.dark textarea { background: #3d3d3d; color: #fff; border-color: #555; }
body.dark .tab { background: #444; color: #ccc; }
body.dark h2 { color: #fff; }
body.dark label { color: #bbb; }
body.dark #supportList { background: #333; border-color: #555; }
body.dark .support-item { border-bottom-color: #444; }

.container {
  max-width: 520px;
  margin: 30px auto;
  background: white;
  padding: 25px;
  border-radius: 14px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
h2 { text-align: center; color: #333; }

/* Tabs */
.tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
}
.tab {
  flex: 1;
  padding: 10px;
  cursor: pointer;
  border: none;
  background: #eee;
  border-radius: 8px;
  transition: background 0.3s;
}
.tab.active {
  background: #32a852;
  color: white;
}

/* Content */
.tab-content { display: none; }
.tab-content.active { display: block; }

.profile {
  text-align: center;
  margin-bottom: 15px;
}
.profile img {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 3px solid #32a852;
  cursor: pointer;
  object-fit: cover;
}

input, select, textarea, button {
  width: 100%;
  padding: 12px;
  margin-top: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

button {
  background: #32a852;
  color: white;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
button:hover { opacity: 0.9; }
button:disabled { background: #ccc !important; cursor: not-allowed; }

.logout {
  background: #d32f2f;
  margin-top: 25px;
}

#supportList {
  margin-top: 15px;
  max-height: 250px;
  overflow-y: auto;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  background: #fafafa;
}
.support-item {
  border-bottom: 1px solid #eee;
  padding: 10px 0;
}
.support-item:last-child { border-bottom: none; }
.support-time {
  font-size: 0.75rem;
  color: #888;
  display: block;
}
label {
  display: block;
  margin-top: 15px;
  font-size: 0.9rem;
  color: #666;
}
.lock-hint {
  font-size: 0.75rem;
  color: #d32f2f;
  margin-top: 4px;
  display: none;
}
</style>
</head>

<body>

<div class="container">
  <h2>Settings</h2>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab" id="tab-personal">Personal</button>
    <button class="tab" id="tab-app">App</button>
    <button class="tab" id="tab-support">Support</button>
  </div>

  <!-- PERSONAL -->
  <div id="content-personal" class="tab-content">
    <div class="profile">
      <img id="avatar" src="https://via.placeholder.com/120" alt="Profile Picture">
      <input type="file" id="photo" accept="image/*" hidden>
      <br><small>Tap image to change</small>
    </div>

    <label for="uid">UID (Read-only)</label>
    <input id="uid" readonly placeholder="UID">
    
    <label for="username">Username</label>
    <input id="username" readonly placeholder="Username">
    
    <label for="name">Full Name</label>
    <input id="name" placeholder="Full Name">
    <div id="name-lock-hint" class="lock-hint">Name can only be changed once.</div>
    
    <label for="age">Age (Read-only)</label>
    <input id="age" type="number" readonly placeholder="Age">
    <div id="age-lock-hint" class="lock-hint" style="display:block;">Age cannot be changed after registration.</div>

    <button id="savePersonal">Save Personal Info</button>
  </div>

  <!-- APP -->
  <div id="content-app" class="tab-content">
    <label for="theme">App Theme</label>
    <select id="theme">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
    </select>
    <button id="saveApp">Save App Settings</button>
  </div>

  <!-- SUPPORT -->
  <div id="content-support" class="tab-content">
    <label for="supportMessage">Contact Support</label>
    <textarea id="supportMessage" rows="4" placeholder="Your message"></textarea>
    <button id="sendSupport">Send</button>
    <div id="supportList"></div>
  </div>

  <button class="logout" id="logoutBtn">Log Out</button>
</div>

<script type="module">
/* 1. Imports aligned with your auth.js and session.js */
import { watchAuth, logoutUser, updateDisplayName } from './auth.js';
import { getSession, saveSession } from './session.js';

// We still need Firestore/Storage for direct data access in Settings
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, addDoc, collection, query, where, orderBy, onSnapshot, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
  getStorage, ref, uploadBytes, getDownloadURL 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

/* ================= FIREBASE INIT (Internal for direct DB access) ================= */
// Note: We use the same config as your auth.js to ensure consistency
const firebaseConfig = {
  apiKey: "AIzaSyDnANsKUAZ1giXXdo-fKkFneMuKh0l0FCg",
  authDomain: "edumateai-6544b.firebaseapp.com",
  projectId: "edumateai-6544b",
  storageBucket: "edumateai-6544b.appspot.com",
  messagingSenderId: "445949748647",
  appId: "1:445949748647:web:40bee0e792098333fa4282"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ================= STATE MANAGEMENT ================= */
let currentUser = null;
let unsubscribeSupport = null;
let userDataFromDB = null;

/* ================= TAB SWITCH ================= */
const tabs = {
  "tab-personal": "content-personal",
  "tab-app": "content-app",
  "tab-support": "content-support"
};

Object.keys(tabs).forEach(tabId => {
  const btn = document.getElementById(tabId);
  btn.onclick = () => {
    Object.keys(tabs).forEach(t => {
      document.getElementById(t).classList.remove("active");
      document.getElementById(tabs[t]).classList.remove("active");
    });
    btn.classList.add("active");
    document.getElementById(tabs[tabId]).classList.add("active");
    sessionStorage.setItem("lastTab", tabId);
    
    if (tabId === 'tab-support') {
        initSupportListener();
    } else if (unsubscribeSupport) {
        unsubscribeSupport();
        unsubscribeSupport = null;
    }
  };
});

const lastTab = sessionStorage.getItem("lastTab") || "tab-personal";
if (document.getElementById(lastTab)) document.getElementById(lastTab).click();

/* ================= ELEMENTS ================= */
const avatar = document.getElementById("avatar");
const photoInput = document.getElementById("photo");
const uidInput = document.getElementById("uid");
const usernameInput = document.getElementById("username");
const nameInput = document.getElementById("name");
const ageInput = document.getElementById("age");
const themeSelect = document.getElementById("theme");
const supportMessage = document.getElementById("supportMessage");
const supportList = document.getElementById("supportList");

/* ================= THEME APPLICATION ================= */
function applyTheme(theme) {
    if (theme === 'dark') {
        document.body.classList.add('dark');
    } else {
        document.body.classList.remove('dark');
    }
}

/* ================= SESSION PERSISTENCE ================= */
async function initFromSession() {
    try {
        const sessionData = await getSession();
        if (sessionData) {
            nameInput.value = sessionData.name || "";
            themeSelect.value = sessionData.theme || "light";
            if (sessionData.photoURL) avatar.src = sessionData.photoURL;
            applyTheme(sessionData.theme);
        }
    } catch (e) { console.error("Session Init Error:", e); }
}
initFromSession();

/* ================= AUTH & DATA SYNC ================= */
// Using watchAuth from your auth.js
watchAuth(async (user) => {
  if (!user) {
    window.location.href = "Login.html";
    return;
  }
  
  currentUser = user;
  uidInput.value = user.uid;
  usernameInput.value = user.displayName || "user_" + user.uid.slice(0,6);

  try {
    const snap = await getDoc(doc(db, "users", user.uid));
    if (snap.exists()) {
      userDataFromDB = snap.data();
      
      nameInput.value = userDataFromDB.name || user.displayName || "";
      ageInput.value = userDataFromDB.age || "";
      themeSelect.value = userDataFromDB.theme || "light";
      if (userDataFromDB.photo) avatar.src = userDataFromDB.photo;
      
      if (userDataFromDB.nameChangedCount >= 1) {
          nameInput.readOnly = true;
          document.getElementById('name-lock-hint').style.display = 'block';
      }

      applyTheme(userDataFromDB.theme);
      
      // Update session.js IndexedDB
      await saveSession({
          uid: user.uid,
          email: user.email,
          name: userDataFromDB.name || user.displayName || "",
          photoURL: userDataFromDB.photo || user.photoURL || "",
          theme: userDataFromDB.theme
      });
    }
  } catch (err) {
    console.error("Sync Error:", err);
  }
});

/* ================= IMAGE PICK ================= */
avatar.onclick = () => photoInput.click();
photoInput.onchange = () => {
  if (photoInput.files[0]) {
    const reader = new FileReader();
    reader.onload = (e) => avatar.src = e.target.result;
    reader.readAsDataURL(photoInput.files[0]);
  }
};

/* ================= SAVE PERSONAL ================= */
document.getElementById("savePersonal").onclick = async () => {
  if (!currentUser) return;
  
  const btn = document.getElementById("savePersonal");
  btn.disabled = true;
  btn.innerText = "Saving...";

  const updateData = {};
  
  // Name change logic
  if (nameInput.value !== (userDataFromDB?.name || currentUser.displayName || "")) {
      if ((userDataFromDB?.nameChangedCount || 0) >= 1) {
          alert("Name can only be changed once.");
          btn.disabled = false;
          btn.innerText = "Save Personal Info";
          return;
      }
      updateData.name = nameInput.value;
      updateData.nameChangedCount = (userDataFromDB?.nameChangedCount || 0) + 1;
      
      // Update Firebase Auth profile via your auth.js function
      try {
          await updateDisplayName(nameInput.value);
      } catch (e) { console.error("Auth Profile Update Error:", e); }
  }

  try {
    if (photoInput.files[0]) {
      const imgRef = ref(storage, `profiles/${currentUser.uid}.jpg`);
      await uploadBytes(imgRef, photoInput.files[0]);
      const url = await getDownloadURL(imgRef);
      updateData.photo = url;
      avatar.src = url;
    }
    
    if (Object.keys(updateData).length > 0) {
        await setDoc(doc(db, "users", currentUser.uid), updateData, { merge: true });
        
        userDataFromDB = { ...userDataFromDB, ...updateData };
        
        // Sync session.js
        await saveSession({
            uid: currentUser.uid,
            email: currentUser.email,
            name: userDataFromDB.name || currentUser.displayName || "",
            photoURL: userDataFromDB.photo || currentUser.photoURL || "",
            theme: userDataFromDB.theme || themeSelect.value
        });
        
        if (userDataFromDB.nameChangedCount >= 1) {
            nameInput.readOnly = true;
            document.getElementById('name-lock-hint').style.display = 'block';
        }
        alert("Personal info updated ✅");
    }
  } catch(err) {
    alert("Save Error: " + err.message);
  } finally {
    btn.disabled = false;
    btn.innerText = "Save Personal Info";
  }
};

/* ================= SAVE APP ================= */
document.getElementById("saveApp").onclick = async () => {
  if (!currentUser) return;
  const newTheme = themeSelect.value;
  try {
    await setDoc(doc(db, "users", currentUser.uid), { theme: newTheme }, { merge: true });
    
    // Update session
    await saveSession({
        uid: currentUser.uid,
        email: currentUser.email,
        name: nameInput.value,
        photoURL: avatar.src,
        theme: newTheme
    });
    
    applyTheme(newTheme);
    alert("Theme saved ✅");
  } catch(err) {
    alert("Error saving theme");
  }
};

/* ================= SUPPORT ================= */
function initSupportListener() {
    if (!currentUser) return;
    
    const q = query(
        collection(db, "support"), 
        where("uid", "==", currentUser.uid),
        orderBy("time", "desc")
    );
    
    unsubscribeSupport = onSnapshot(q, (snap) => {
        supportList.innerHTML = "";
        snap.forEach(docu => {
            const data = docu.data();
            const div = document.createElement("div");
            div.className = "support-item";
            const time = data.time ? new Date(data.time.seconds * 1000).toLocaleString() : "Sending...";
            div.innerHTML = `<span class="support-time">${time}</span><div>${data.message}</div>`;
            supportList.appendChild(div);
        });
    }, (err) => {
        console.error("Support Listener Error:", err);
    });
}

document.getElementById("sendSupport").onclick = async () => {
  if (!currentUser) return;
  const msg = supportMessage.value.trim();
  if (!msg) return;

  try {
    await addDoc(collection(db, "support"), {
      uid: currentUser.uid,
      message: msg,
      time: serverTimestamp()
    });
    supportMessage.value = "";
  } catch(err) {
    alert("Error sending message");
  }
};

/* ================= LOGOUT ================= */
document.getElementById("logoutBtn").onclick = async () => {
  try {
    await logoutUser();
    // Redirect is handled by watchAuth, but explicit for safety
    window.location.href = "Login.html";
  } catch(err) {
    console.error("Logout error:", err);
  }
};
</script>

</body>
</html>
